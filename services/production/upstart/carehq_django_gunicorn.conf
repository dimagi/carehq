# Upstart django script
# this script will start/stop the django server running via a management command
# In Ubuntu, symlink this script to /etc/init/
description "start and stop the carehq django project"

# configuration variables.
# You'll want to change these as needed
env PROJECT_NAME=carehq
env DJANGO_HOME=/opt/carehq_project/src/carehq #where manage.py is
env DJANGO_PORT=8001
env DJANGO_HOST=0.0.0.0 # bind to 0.0.0.0 or other port where needed
env DJANGO_VIRTUALENV=/home/carehq/.virtualenvs/carehq
env PROJECT_USER=carehq
env LOG_PATH=/opt/carehq_project/log/carehq_upstart.log
env GUNICORN_LOG_PATH=/opt/carehq_project/log/carehq_upstart.gunicorn.log

expect fork
respawn

pre-start script
        chdir $DJANGO_HOME
end script

script
        # Note, we're using the virtualenv's python interpreter.  Calling source/workon doesn't work here, so just call the ENV's executable instead.
        exec sudo -u $PROJECT_USER $DJANGO_VIRTUALENV/bin/python $DJANGO_HOME/manage.py run_gunicorn $DJANGO_HOST:$DJANGO_PORT --preload -w 5 --log-file $GUNICORN_LOG_PATH --timeout 60 --log-level debug >> $LOG_PATH &

end script